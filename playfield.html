<html><head>
<title>John's Shooting range</title>
<link rel="stylesheet" type="text/css" href="stylesheets/custom.css">
</head>

<body style="">
	<div class="confirm-button" id="btnConfirm">I'm ready for Rock 'n Roll</div>
	<div id="name-entry" class="form form-nick" style="display: none;">
		<form id="frmRegister">
			<label for="txtNickname">Nickname</label>
			<input id="txtNickname" type="text">
			<label id="errNickname"></label>			
			<input type="submit" value="Let's go">
		</form>
	</div>
	<div id="initserver" class="form form-initserver" style="display: none;">
		<form id="frmInitserver">
			<input type="radio" name="gameId" class="serv-game-id" checked="" value="1">1. shootout<br>
			Play for <input type="text" name="gameSeconds" class="serv-game-secs" value="60"> seconds<br>
			Amount of targets X<input type="text" name="gameTargetsX" class="serv-game-targetsX" value="9">  <br>
			Amount of targets Y<input type="text" name="gameTargetsY" class="serv-game-targetsY" value="5">  <br>
			<input type="submit" value="start server">
		</form>
	</div>
	<div id="panePlayers" class="pane pane-players">dsfdg<br>sdfg<br>sdhgdfgnvb<br>sghcvnb<br></div>
	<div id="loader" class="loading" style="display: none;">Waiting for all player... Stay steady!</div>
	<div id="paneController" class="pane pane-ctrl"></div>
	<div id="paneShootingrange" class="pane pane-shootingrange act">
		<div class="playerstat-container">
			<div class="playerstat act">
				<div class="playerstat-statcont">
					<div class="playerstat-name player-color-1">dsfdg</div>
					<div class="playerstat-points"><p></p></div>
					<div class="playerstat-points-bg"></div>
					<div class="playerstat-gunchamber-shadow"></div>
					<div class="playerstat-gunchamber barrel-0"></div>
				</div>
			</div>
			<!-- end .playerstat -->
			<div class="playerstat act">
				<div class="playerstat-statcont">
					<div class="playerstat-name player-color-2 even">sdfg</div>
					<div class="playerstat-points even"><p></p></div>
					<div class="playerstat-points-bg even"></div>
					<div class="playerstat-gunchamber-shadow even"></div>
					<div class="playerstat-gunchamber barrel-0 even"></div>
				</div>
			</div>
			<!-- end .playerstat -->
			<div class="playerstat act">
				<div class="playerstat-statcont">
					<div class="playerstat-name player-color-3 even">sdhgdfgnvb</div>
					<div class="playerstat-points even"><p></p></div>
					<div class="playerstat-points-bg even"></div>
					<div class="playerstat-gunchamber-shadow even"></div>
					<div class="playerstat-gunchamber barrel-0 even"></div>
				</div>
			</div>
			<!-- end .playerstat -->
			<div class="playerstat act">
				<div class="playerstat-statcont">
					<div class="playerstat-name player-color-4">sghcvnb</div>
					<div class="playerstat-points"><p></p></div>
					<div class="playerstat-points-bg"></div>
					<div class="playerstat-gunchamber-shadow"></div>
					<div class="playerstat-gunchamber barrel-0"></div>
				</div>
			</div>
			<!-- end .playerstat -->
		</div>
	</div>
	

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="socket.io/socket.io.js"></script>
	<script>
	jQuery(function($){
		var socket = io.connect();
		var $body = $('body');
		var $initserver = $('#initserver');
		var $nameEntry = $('#name-entry');
		var $nickForm = $('#frmRegister');
		var $nickError = $('#errNickname');
		var $initForm = $('#frmInitserver');
		var $rbtGameId = $('#rbtGameId');
		var $txtNickName = $('#txtNickname');
		var $players= $('#panePlayers');
		var $controllerPane = $('#paneController');
		var $shootingPane=$('#paneShootingrange');
		var $confirmButton =$('#btnConfirm');

		var $loader = $('#loader');
		var $isServer = false;
		var $rnd = 1;
		var $nickname="";

		function showPlayer(player,n){
			console.log("showPlayer "+ player.nickname +" "+ n);
			$('.playerstat').eq(n).toggleClass("act");
			$('.playerstat-name').eq(n).text(player.nickname);
			$('.playerstat-name').eq(n).toggleClass(player.color);


		}


		function showPlayers(players){
			//var j=0;
			for(var i=0;i<players.length;i++){
				console.log('showPlayers() - PLAYER: ',players[i].nickname);
				//j++;
				showPlayer(players[i], i);
			}

		}

		function initShootingRange(amountX, amountY){
			for(var i=0;i<amountY;i++){
				for(var j=0;j<amountX;j++){
					$shootingPane.append("<div class='target-"+j+"-"+i+"'></div>");
				}
			}			

		}

		function showDialog(){
			$confirmButton.show();
			//show confirm buttom. When clicked, the server will receive a signal			
			$confirmButton.click(function(){
		        console.log('Pushed tha button');
				socket.emit('player approved',$nickname);
				$(this).hide();
			});			
		}

		function initRound(game, gamers){
			showPlayers(gamers);
			initShootingRange(game.gameTargetsX,game.TargetsY);



		}
		
		/******** FIRE AT WILL *************/

		$controllerPane.on('touchstart', function(e) {
		  var posX = e.originalEvent.touches[0].pageX;
		  var posY = e.originalEvent.touches[0].pageY;
		  socket.emit('shot',{nick:$nickname,posX:posX,posY:posY}, function(data){
		  	console.log("Shot data:"+data);

		  });

		});

		/**
		/*$controllerPane.click(function(){
		  var xPos = 50;
		  socket.emit('shot',{nick:$nickname,pos:xPos}, function(data){
		  	console.log("Shot data:"+data);
		  });

		});*/

		$nickForm.submit(function(e){
			e.preventDefault();
			$nickname = $txtNickName.val();
			socket.emit('send nick',$nickname,function(data){
				if(data){
					$nameEntry.hide();
					$initserver.hide();
					$controllerPane.show();
					$players.show();

				}else{
					$nickError.html('Nickname already taken. Try another one!');
				}
			});
		});
		$initForm.submit(function(e){

			e.preventDefault();
			//console.log($initForm.serializeArray());
			//Send request for a new game
			var formData = $initForm.serializeArray();
			//console.log("formData[0].name client :"+ formData[0].name + "   " + formData[0].value);
			//console.log("formData[1].name client :"+ formData[1].name + "   " + formData[1].value);
			socket.emit('ngrequest',formData);
			$nameEntry.hide();
			$isServer = true;
			$initserver.hide();
			


		});




		socket.on('usernames',function(data){
			var html='';
			for(i=0; i<data.length;i++){
				html+= data[i] +'<br>';
			}

			$players.html(html);

			
		});
		socket.on('requestready',function(data){
			
			
			if(!$isServer){
				//show confirmation dialog to all players
				showDialog();
			}else{
				//show loader on server interface
				$loader.toggle();
			}
			

		});
		socket.on('start',function(game,gamers){
			console.log('requestready game - gameId: '+game.gameId + ' - gameSeconds: '+game.gameSeconds );
			if($isServer){
				$loader.toggle();
				alert('the game has begun!');
				$shootingPane.addClass('act');
				console.log("socket on start - game:" + game.gameId +"gamers:" + gamers[0].nickname);
				initRound(game,gamers);
			}
		});
		socket.on('showshot',function(data){
			
			if($isServer){
				console.log(data);
			}


		});
	});




	</script>


</body></html>